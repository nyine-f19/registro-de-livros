<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Diário de Leitura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
        }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label {
            font-size: 2rem;
            color: #4b5563; /* gray-600 */
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f59e0b; /* amber-500 */
        }
        .book-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .category-btn.active {
            background-color: #991b1b; /* red-800 */
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-300">

    <!-- Container Principal -->
    <div class="container mx-auto max-w-7xl px-4 py-8">
        
        <!-- Informação do Utilizador e Logout -->
        <div id="user-info-container" class="absolute top-4 right-4 flex items-center gap-2 sm:gap-4 hidden">
            <div class="text-right">
                <p id="user-name" class="font-semibold text-white text-sm sm:text-base"></p>
                <p id="user-email" class="text-xs text-gray-400 hidden sm:block"></p>
            </div>
            <img id="user-photo" class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-red-700" alt="Foto do utilizador">
            <button id="logout-btn" class="bg-gray-700 hover:bg-red-800 text-white font-bold py-1 px-2 sm:py-2 sm:px-4 rounded-lg transition-colors">
                Sair
            </button>
        </div>

        <!-- Tela de Login -->
        <div id="login-screen" class="text-center py-20 flex flex-col items-center justify-center min-h-screen">
             <i class="fas fa-book-reader text-8xl text-red-800 mb-6"></i>
            <h1 class="text-5xl font-bold text-white mb-4">Bem-vindo(a) ao seu Diário de Leitura</h1>
            <p class="text-gray-400 text-lg mb-8 max-w-2xl">Aceda à sua estante pessoal a partir de qualquer dispositivo. Inicie sessão para começar a guardar as suas aventuras literárias.</p>
            <button id="login-btn" class="bg-red-800 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-700 transition-colors text-xl flex items-center gap-3 shadow-lg">
                <i class="fab fa-google"></i>
                <span>Entrar com Google</span>
            </button>
            <div id="login-error-message" class="mt-8"></div>
        </div>
        
        <!-- Conteúdo Principal do App (inicialmente escondido) -->
        <main id="main-content" class="hidden">
            <!-- Cabeçalho -->
            <header class="text-center mb-8 pt-16">
                <h1 class="text-4xl md:text-5xl font-bold text-white">Meu Diário de Leitura</h1>
                <p class="text-gray-400 mt-2">Anote, avalie e relembre as suas aventuras literárias.</p>
            </header>

            <!-- Barra de Ações -->
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <div class="relative flex-grow">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-gray-500"></i>
                    </span>
                    <input type="text" id="searchInput" placeholder="Buscar por título ou autor..." class="w-full pl-10 pr-4 py-2 border rounded-lg bg-gray-900 border-gray-700 focus:outline-none focus:ring-2 focus:ring-red-600 text-gray-200">
                </div>
                <button id="addBookBtn" class="w-full md:w-auto bg-red-800 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i>
                    <span>Adicionar Livro</span>
                </button>
            </div>

            <!-- Filtro de Categorias -->
            <div id="category-filters" class="mb-8 flex flex-wrap gap-2 justify-center">
                <!-- Botões de categoria serão inseridos aqui -->
            </div>

            <!-- Seção de Livros -->
            <div id="bookList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Cards de livros serão inseridos aqui -->
            </div>
            
            <div id="loadingState" class="text-center py-10 hidden">
                <p class="text-gray-500">A carregar os seus livros...</p>
            </div>

            <div id="emptyState" class="text-center py-20 hidden">
                <i class="fas fa-book-open text-6xl text-gray-600"></i>
                <h3 class="text-2xl font-semibold mt-4 text-white">A sua estante está vazia</h3>
                <p class="text-gray-500 mt-2">Clique em "Adicionar Livro" para começar a sua coleção!</p>
            </div>
        </main>
    </div>

    <!-- Modal para Adicionar/Editar Livro -->
    <div id="bookModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
            <form id="bookForm" class="p-6">
                <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-white">Adicionar Novo Livro</h2>
                <input type="hidden" id="bookId">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Coluna da Esquerda: Campos de Texto -->
                    <div>
                        <div class="mb-4">
                            <label for="title" class="block mb-1 font-semibold text-gray-300">Título</label>
                            <input type="text" id="title" class="w-full p-2 border rounded-lg bg-gray-800 border-gray-700 text-gray-200 focus:ring-2 focus:ring-red-600" required>
                        </div>
                        <div class="mb-4">
                            <label for="author" class="block mb-1 font-semibold text-gray-300">Autor</label>
                            <input type="text" id="author" class="w-full p-2 border rounded-lg bg-gray-800 border-gray-700 text-gray-200 focus:ring-2 focus:ring-red-600" required>
                        </div>
                        <div class="mb-4">
                            <label for="category" class="block mb-1 font-semibold text-gray-300">Categoria</label>
                            <select id="category" class="w-full p-2 border rounded-lg bg-gray-800 border-gray-700 text-gray-200 focus:ring-2 focus:ring-red-600">
                                <!-- Opções de categoria serão inseridas aqui -->
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="publisher" class="block mb-1 font-semibold text-gray-300">Editora</label>
                                <input type="text" id="publisher" class="w-full p-2 border rounded-lg bg-gray-800 border-gray-700 text-gray-200 focus:ring-2 focus:ring-red-600">
                            </div>
                            <div>
                                <label for="pubYear" class="block mb-1 font-semibold text-gray-300">Ano</label>
                                <input type="number" id="pubYear" class="w-full p-2 border rounded-lg bg-gray-800 border-gray-700 text-gray-200 focus:ring-2 focus:ring-red-600">
                            </div>
                        </div>
                         <div class="mb-4">
                            <label for="coverUrl" class="block mb-1 font-semibold text-gray-300">URL da Capa</label>
                            <input type="url" id="coverUrl" placeholder="Cole uma URL ou envie um ficheiro" class="w-full p-2 border rounded-lg bg-gray-800 border-gray-700 text-gray-200 focus:ring-2 focus:ring-red-600">
                        </div>
                         <div class="mb-4">
                            <label for="coverImageFile" class="block mb-1 font-semibold text-gray-300">Ou envie da galeria</label>
                            <input type="file" id="coverImageFile" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-red-800 file:text-white hover:file:bg-red-700 cursor-pointer">
                            <img id="coverPreview" src="" alt="Pré-visualização da capa" class="mt-4 rounded-lg hidden w-32 h-48 object-cover mx-auto"/>
                        </div>
                    </div>

                    <!-- Coluna da Direita: Avaliação e Resumo -->
                    <div>
                       <div class="mb-4">
                            <label class="block mb-2 font-semibold text-gray-300">A sua Avaliação</label>
                            <div class="star-rating flex flex-row-reverse justify-end items-center">
                                <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 estrelas">★</label>
                                <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 estrelas">★</label>
                                <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 estrelas">★</label>
                                <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 estrelas">★</label>
                                <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 estrela">★</label>
                            </div>
                        </div>
                        <div class="mb-4">
                             <div class="flex justify-between items-center mb-1">
                                <label for="summary" class="block font-semibold text-gray-300">Resumo / Anotações</label>
                                <button type="button" id="generateSummaryBtn" class="text-sm text-red-400 hover:text-red-300 flex items-center gap-1 transition-colors">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                    <span id="generateBtnText">Gerar com IA</span>
                                </button>
                            </div>
                            <textarea id="summary" rows="8" class="w-full p-2 border rounded-lg bg-gray-800 border-gray-700 text-gray-300 focus:ring-2 focus:ring-red-600"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Botões do formulário -->
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelBtn" class="py-2 px-4 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600">Cancelar</button>
                    <button type="submit" class="py-2 px-6 bg-red-800 text-white font-semibold rounded-lg hover:bg-red-700">Salvar Livro</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div id="deleteConfirmationModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-full max-w-sm border border-gray-700">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-white">Confirmar Exclusão</h3>
                <p class="text-gray-400 mb-6">Tem a certeza que quer excluir este livro? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-center gap-4">
                     <button id="cancelDeleteBtn" class="py-2 px-4 bg-gray-700 rounded-lg hover:bg-gray-600">Cancelar</button>
                     <button id="confirmDeleteBtn" class="py-2 px-6 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-800">Excluir</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Módulo do Firebase -->
    <script type="module">
        // Importe as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCW7mk6z_ofpngUoQXkuPDsdfpUX40zGoI",
            authDomain: "diario-de-livros-da-gatinha.firebaseapp.com",
            projectId: "diario-de-livros-da-gatinha",
            storageBucket: "diario-de-livros-da-gatinha.firebasestorage.app",
            messagingSenderId: "150340409712",
            appId: "1:150340409712:web:0bf33685d9ae61b91f97b5",
            measurementId: "G-TB2L9WB1VB"
        };

        // Variáveis globais
        let app, auth, db, userId;
        let booksUnsubscribe = null;
        let booksCache = [];
        let bookToDeleteId = null;
        let uploadedCoverDataUrl = null;
        let activeCategory = 'Todos'; // Nova variável para o filtro ativo

        const categories = ['Ficção', 'Não Ficção', 'Romance', 'Fantasia', 'Suspense', 'Biografia', 'Poesia', 'Outro'];

        // Elementos da UI
        const mainContent = document.getElementById('main-content');
        const loginScreen = document.getElementById('login-screen');
        const loginBtn = document.getElementById('login-btn');
        const loginErrorMessage = document.getElementById('login-error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoContainer = document.getElementById('user-info-container');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const userPhotoEl = document.getElementById('user-photo');
        const categoryFiltersContainer = document.getElementById('category-filters');
        const bookModal = document.getElementById('bookModal');
        const bookForm = document.getElementById('bookForm');
        const bookList = document.getElementById('bookList');
        const searchInput = document.getElementById('searchInput');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const generateSummaryBtn = document.getElementById('generateSummaryBtn');
        const coverImageFile = document.getElementById('coverImageFile');
        const coverPreview = document.getElementById('coverPreview');
        const categorySelect = document.getElementById('category');


        // Função para chamar a API do Gemini
        async function callGeminiAPI(prompt) {
            const apiKey = "AIzaSyAlW8uGk_kooI8IkbTtduu2LoiW7Y7SOVc"; // SUBSTITUA PELA SUA CHAVE RESTRITA
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`A requisição para a API falhou com status ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                }
                return null;
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                return null;
            }
        }


        // Manipulador para gerar resumo com IA
        async function handleGenerateSummary() {
            const title = document.getElementById('title').value;
            const author = document.getElementById('author').value;

            if (!title || !author) {
                alert("Por favor, preencha o título e o autor do livro para gerar um resumo.");
                return;
            }

            const generateBtnText = document.getElementById('generateBtnText');
            generateBtnText.textContent = 'A gerar...';
            generateSummaryBtn.disabled = true;
            
            const prompt = `Crie um resumo conciso e envolvente, com no máximo 3 parágrafos, para o livro "${title}" de ${author}. O resumo deve capturar os temas principais e o tom da obra, sem revelar spoilers importantes.`;
            const generatedSummary = await callGeminiAPI(prompt);

            if (generatedSummary) {
                document.getElementById('summary').value = generatedSummary;
            } else {
                alert("Não foi possível gerar o resumo. Tente novamente mais tarde.");
            }
            
            generateBtnText.textContent = 'Gerar com IA';
            generateSummaryBtn.disabled = false;
        }


        // Inicializa o App Firebase
        function initializeFirebase() {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            renderCategoryUI();
            handleAuthentication();
        }

        // --- LÓGICA DE AUTENTICAÇÃO ---
        function handleAuthentication() {
            onAuthStateChanged(auth, user => {
                if (user) { // Utilizador está logado
                    userId = user.uid;
                    updateUIForLoggedInUser(user);
                    loadBooks();
                } else { // Utilizador não está logado
                    if(booksUnsubscribe) booksUnsubscribe(); // Para o listener de livros se existir
                    updateUIForLoggedOutUser();
                }
            });
        }
        
        function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Erro ao fazer login com Google:", error);
                loginErrorMessage.innerHTML = ''; // Limpa mensagens de erro antigas
                if (error.code === 'auth/unauthorized-domain') {
                    loginErrorMessage.innerHTML = `
                        <div class="text-red-400 font-bold p-4 border border-red-500 rounded-lg bg-red-900/20 max-w-2xl mx-auto">
                            <p class="text-lg mb-2">Domínio Não Autorizado!</p>
                            <p>O site onde está a executar a aplicação não tem permissão para usar o login do Google.</p>
                            <p class="mt-2"><b>Como resolver:</b></p>
                            <ol class="list-decimal list-inside text-left max-w-lg mx-auto mt-1">
                                <li>Vá para o seu projeto no <a href="https://console.firebase.google.com/" target="_blank" class="underline hover:text-white">Console do Firebase</a>.</li>
                                <li>No menu, clique em <b>Build > Authentication</b>.</li>
                                <li>Vá para a aba <b>Settings</b> (Definições).</li>
                                <li>Na secção <b>Domínios autorizados</b>, clique em <b>Adicionar domínio</b>.</li>
                                <li>Adicione o domínio de onde está a executar o site (ex: <b>seu-usuario.github.io</b>).</li>
                                <li>Clique em <b>Adicionar</b> e depois atualize esta página.</li>
                            </ol>
                        </div>
                    `;
                } else {
                    alert("Não foi possível fazer o login. Por favor, tente novamente.");
                }
            });
        }
        
        function logout() {
            signOut(auth).catch(error => {
                console.error("Erro ao fazer logout:", error);
            });
        }
        
        // --- ATUALIZAÇÕES DA UI ---
        function updateUIForLoggedInUser(user) {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            userInfoContainer.classList.remove('hidden');
            
            userNameEl.textContent = user.displayName;
            userEmailEl.textContent = user.email;
            userPhotoEl.src = user.photoURL;
            loginErrorMessage.innerHTML = ''; // Limpa a mensagem de erro se o login for bem-sucedido
        }

        function updateUIForLoggedOutUser() {
            mainContent.classList.add('hidden');
            userInfoContainer.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            bookList.innerHTML = ''; // Limpa a lista de livros
        }
        
        // --- LÓGICA DE CATEGORIAS ---
        function renderCategoryUI() {
            // Renderiza os botões de filtro
            categoryFiltersContainer.innerHTML = '';
            const allCategories = ['Todos', ...categories];
            allCategories.forEach(cat => {
                const btn = document.createElement('button');
                btn.textContent = cat;
                btn.dataset.category = cat;
                btn.className = 'category-btn px-3 py-1 text-sm rounded-full bg-gray-800 text-gray-300 hover:bg-red-900 transition-colors';
                if (cat === activeCategory) {
                    btn.classList.add('active');
                }
                categoryFiltersContainer.appendChild(btn);
            });

            // Preenche o select do modal
            categorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }
        
        // --- LÓGICA DOS LIVROS ---
        function applyFiltersAndRender() {
            let filteredBooks = booksCache;

            // 1. Filtrar por categoria
            if (activeCategory !== 'Todos') {
                filteredBooks = filteredBooks.filter(book => book.category === activeCategory);
            }

            // 2. Filtrar por pesquisa
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredBooks = filteredBooks.filter(book => 
                    book.title.toLowerCase().includes(searchTerm) || 
                    book.author.toLowerCase().includes(searchTerm)
                );
            }

            renderBooks(filteredBooks);
        }

        function loadBooks() {
            if (booksUnsubscribe) booksUnsubscribe();
            
            loadingState.classList.remove('hidden');
            emptyState.classList.add('hidden');
            bookList.innerHTML = '';

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const booksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/books`);
            const q = query(booksCollectionRef);

            booksUnsubscribe = onSnapshot(q, (snapshot) => {
                loadingState.classList.add('hidden');
                booksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyFiltersAndRender();
                
            }, (error) => {
                console.error("Erro ao carregar livros: ", error);
                loadingState.innerHTML = `<p class="text-red-500 font-bold">Ocorreu um erro ao carregar os livros. Verifique se as regras do Firestore estão corretas.</p>`;
            });
        }

        function renderBooks(booksToRender) {
            bookList.innerHTML = '';
            if (booksToRender.length === 0) {
                emptyState.classList.remove('hidden');
                bookList.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                bookList.classList.remove('hidden');
            }

            booksToRender.forEach(book => {
                const pubYear = book.pubYear ? `(${book.pubYear})` : '';
                const ratingStars = '★'.repeat(book.rating || 0) + '☆'.repeat(5 - (book.rating || 0));
                
                const card = document.createElement('div');
                card.className = 'bg-gray-900 rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300 book-card border border-gray-800';
                card.innerHTML = `
                    <img src="${book.coverUrl || 'https://placehold.co/400x600/b91c1c/ffffff?text=Capa'}" alt="Capa de ${book.title}" class="w-full h-52 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1f2937/ffffff?text=Erro!';">
                    <div class="p-3 flex flex-col flex-grow">
                        <div>
                            <h3 class="text-lg font-bold text-white leading-tight">${book.title}</h3>
                            <p class="text-sm text-gray-400 mb-2">${book.author} ${pubYear}</p>
                             <p class="text-xs text-red-400 font-semibold mb-2">${book.category || 'Sem Categoria'}</p>
                            <p class="text-amber-500 text-lg mb-2" title="${book.rating || 0} de 5 estrelas">${ratingStars}</p>
                        </div>
                         <div class="mt-auto pt-2 flex justify-end gap-3">
                            <button class="edit-btn text-gray-400 hover:text-white transition-colors" data-id="${book.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors" data-id="${book.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                bookList.appendChild(card);
            });
        }
        
        function toggleModal(show, book = null) {
            bookForm.reset();
            document.getElementById('bookId').value = '';
            document.querySelectorAll('.star-rating input').forEach(r => r.checked = false);
            
            coverPreview.classList.add('hidden');
            coverPreview.src = '';
            uploadedCoverDataUrl = null;
            coverImageFile.value = '';
            categorySelect.value = categories[0];

            if (show) {
                if (book) {
                    document.getElementById('modalTitle').textContent = 'Editar Livro';
                    document.getElementById('bookId').value = book.id;
                    document.getElementById('title').value = book.title;
                    document.getElementById('author').value = book.author;
                    document.getElementById('publisher').value = book.publisher || '';
                    document.getElementById('pubYear').value = book.pubYear || '';
                    document.getElementById('summary').value = book.summary || '';
                    categorySelect.value = book.category || categories[0];

                    if (book.rating) document.getElementById(`star${book.rating}`).checked = true;
                    if (book.coverUrl) {
                        if (book.coverUrl.startsWith('data:image')) {
                            coverPreview.src = book.coverUrl;
                            coverPreview.classList.remove('hidden');
                        } else {
                            document.getElementById('coverUrl').value = book.coverUrl;
                        }
                    }
                } else {
                    document.getElementById('modalTitle').textContent = 'Adicionar Novo Livro';
                }
                bookModal.classList.remove('hidden');
            } else {
                bookModal.classList.add('hidden');
            }
        }
        
        function toggleDeleteModal(show, bookId = null) {
            if(show) {
                bookToDeleteId = bookId;
                deleteConfirmationModal.classList.remove('hidden');
            } else {
                bookToDeleteId = null;
                deleteConfirmationModal.classList.add('hidden');
            }
        }

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', logout);
        document.getElementById('addBookBtn').addEventListener('click', () => toggleModal(true));
        document.getElementById('cancelBtn').addEventListener('click', () => toggleModal(false));
        generateSummaryBtn.addEventListener('click', handleGenerateSummary);
        
        searchInput.addEventListener('input', applyFiltersAndRender);

        categoryFiltersContainer.addEventListener('click', (e) => {
            if(e.target.matches('.category-btn')) {
                activeCategory = e.target.dataset.category;
                // Atualiza o visual dos botões
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                applyFiltersAndRender();
            }
        });
        
        coverImageFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedCoverDataUrl = e.target.result;
                    coverPreview.src = uploadedCoverDataUrl;
                    coverPreview.classList.remove('hidden');
                    document.getElementById('coverUrl').value = '';
                };
                reader.readAsDataURL(file);
            }
        });

        bookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('bookId').value;
            const ratingInput = document.querySelector('input[name="rating"]:checked');
            let coverUrlValue = uploadedCoverDataUrl || document.getElementById('coverUrl').value;
            const bookData = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                publisher: document.getElementById('publisher').value,
                pubYear: document.getElementById('pubYear').value,
                coverUrl: coverUrlValue,
                summary: document.getElementById('summary').value,
                rating: ratingInput ? parseInt(ratingInput.value) : 0,
                category: categorySelect.value
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `artifacts/${appId}/users/${userId}/books`;

            try {
                if (id) {
                    await setDoc(doc(db, collectionPath, id), bookData, { merge: true });
                } else {
                    await addDoc(collection(db, collectionPath), bookData);
                }
                toggleModal(false);
            } catch (error) {
                console.error("Erro ao salvar livro: ", error);
            }
        });
        
        bookList.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (editBtn) {
                const book = booksCache.find(b => b.id === editBtn.dataset.id);
                if(book) toggleModal(true, book);
            }
            if (deleteBtn) {
                toggleDeleteModal(true, deleteBtn.dataset.id);
            }
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => toggleDeleteModal(false));
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (bookToDeleteId) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/books`, bookToDeleteId));
                    toggleDeleteModal(false);
                } catch (error) {
                    console.error("Erro ao excluir livro: ", error);
                }
            }
        });

        // Inicia tudo
        initializeFirebase();

    </script>
</body>
</html>
